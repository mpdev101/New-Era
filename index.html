<!-- Enable-Earth Interactive Map – Add Plot + History + Ctrl-Click Routing -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Enable Earth Demo Map</title>

  <!-- Leaflet & Plugins -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">

  <style>
    :root{
      --primary:#024a18;--secondary:#E8F4E5;--accent:#336633;
    }
    *{box-sizing:border-box}body{margin:0;font-family:Arial;background:var(--secondary)}
    header{background:var(--primary);padding:10px;text-align:center}
    header img{height:40px}
    #controls{background:var(--primary);padding:10px;text-align:center}
    #controls button{margin:0 5px;padding:8px 12px;background:var(--accent);color:#fff;border:none;border-radius:4px;cursor:pointer}
    #controls button:hover{background:#295427}
    #add-form-container{display:none;background:#fff;padding:10px;border-bottom:1px solid #ccc}
    #add-form input{margin:5px;padding:5px;width:100px;border:1px solid #ccc;border-radius:4px}
    #map{height:50vh}
    #history{padding:10px;background:#fff;border-top:1px solid #ccc}
    #history h3{margin:0;color:var(--primary)}
  </style>
</head>
<body>
  <header>
    <a href="https://enableearth.eco" target="_blank"><img src="logo.png" alt="logo"></a>
  </header>

  <div id="controls"></div>

  <!-- ฟอร์ม Add Plot -->
  <div id="add-form-container">
    <form id="add-form">
      <input id="input-id"  placeholder="Plot ID"      required>
      <input id="input-lat" placeholder="Latitude"     type="number" step="any" required>
      <input id="input-lng" placeholder="Longitude"    type="number" step="any" required>
      <input id="input-carbon" placeholder="Carbon"    type="number" step="any" required>
      <button type="button" id="btn-save">Save</button>
      <button type="button" id="btn-cancel">Cancel</button>
    </form>
  </div>

  <div id="map"></div>
  <div id="history"><p>Select a plot to view history.</p></div>

  <!-- JS libs -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  /* ---------- GLOBAL STATE ---------- */
  let map, geoLayer, data, routingCtl;
  let selectedPoints = [];            // เก็บ 2 จุดที่ Ctrl-click

  /* ---------- INITIALISE MAP ---------- */
  function initMap(){
    map = L.map('map').setView([18.3,100.5],10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);

    L.Control.geocoder({defaultMarkGeocode:false})
      .on('markgeocode', e=>map.fitBounds(e.geocode.bbox))
      .addTo(map);

    fetch('call.geojson')
      .then(r=>r.json())
      .then(json=>{
        data={ type:'FeatureCollection',
               features:json.features.map(f=>({...f,properties:{hasHistory:true,...f.properties}}))};
        drawLayer();
        buildControls();
        setupForm();
      });
  }

  /* ---------- DRAW / REFRESH LAYER ---------- */
  function drawLayer(filterFn){
    if(geoLayer) map.removeLayer(geoLayer);
    const feats = filterFn? data.features.filter(filterFn): data.features;

    geoLayer = L.geoJSON(feats,{
      pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:6,color:getComputedStyle(document.documentElement).getPropertyValue('--accent').trim()}),
      onEachFeature:(f,lyr)=>{
        lyr.bindPopup(`<strong>${f.properties.plot_id}</strong><br>CO₂ ${f.properties.carbon_credit}`);
        // Ctrl+Click  → add to selectedPoints
        lyr.on('click',e=>{
          if(!e.originalEvent.ctrlKey) return;
          selectedPoints.push(e.latlng);
          if(selectedPoints.length===2){
            routeBetween(selectedPoints[0],selectedPoints[1]);
            selectedPoints=[];          // reset
          }
        });
      }
    }).addTo(map);

    if(feats.length) map.fitBounds(geoLayer.getBounds());
  }

  /* ---------- CONTROLS ---------- */
  function buildControls(){
    const c=document.getElementById('controls'); c.innerHTML='';
    addBtn(c,'Show All',()=>{ drawLayer(); showHistory(); });
    addBtn(c,'History Plots',()=>{ drawLayer(f=>f.properties.hasHistory); showHistory(); });
    addBtn(c,'Add Plot',()=>toggleForm(true));
  }
  function addBtn(p,t,fn){ const b=document.createElement('button'); b.textContent=t; b.onclick=fn; p.appendChild(b); }

  /* ---------- ADD PLOT FORM ---------- */
  function setupForm(){
    document.getElementById('btn-save').onclick=()=>{
      const id  =document.getElementById('input-id').value.trim();
      const lat =parseFloat(document.getElementById('input-lat').value);
      const lng =parseFloat(document.getElementById('input-lng').value);
      const car =parseFloat(document.getElementById('input-carbon').value);
      if(!id||isNaN(lat)||isNaN(lng)||isNaN(car)) return alert('กรุณากรอกให้ครบ');

      data.features.push({ type:'Feature',
        properties:{ plot_id:id, carbon_credit:car, hasHistory:true },
        geometry:{ type:'Point', coordinates:[lng,lat] } });

      toggleForm(false); drawLayer(); buildControls(); showHistory(id);
    };
    document.getElementById('btn-cancel').onclick=()=>toggleForm(false);
  }
  function toggleForm(sh){document.getElementById('add-form-container').style.display=sh?'block':'none';}

  /* ---------- HISTORY ---------- */
  function showHistory(id){
    const h=document.getElementById('history');
    if(!id){ h.innerHTML='<p>Select a plot to view history.</p>'; return; }
    const logs=['2023-01-01 Registered','2023-03-15 No-burn','2023-06-20 Certificate'];
    h.innerHTML=`<h3>History for ${id}</h3><ul>${logs.map(l=>`<li>${l}</li>`).join('')}</ul>
                 <button onclick=\"exportPDF('${id}')\">Export PDF</button>`;
  }
  function exportPDF(id){
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF(); doc.setFontSize(16); doc.text(`Certificate for ${id}`,20,20);
    ['2023-01-01','2023-03-15','2023-06-20'].forEach((l,i)=>doc.text(l,20,30+10*i));
    doc.save(`certificate_${id}.pdf`);
  }

  /* ---------- ROUTING CTRL-CLICK ---------- */
  function routeBetween(p1,p2){
    if(routingCtl) map.removeControl(routingCtl);
    routingCtl = L.Routing.control({
      waypoints:[p1,p2],
      lineOptions:{styles:[{color:'blue',opacity:.6,weight:4}]},
      createMarker:()=>null,
      addWaypoints:false,
      routeWhileDragging:false,
      fitSelectedRoutes:true
    }).addTo(map);
  }

  document.addEventListener('DOMContentLoaded',initMap);
  </script>
</body>
</html>
