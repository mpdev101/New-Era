<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>Enable Earth Demo Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    :root{--primary:#024a18;--secondary:#E8F4E5;--accent:#336633;}
    body{margin:0;font-family:Arial;background:var(--secondary);}
    header{background:var(--primary);padding:10px;text-align:center;}
    header img{height:40px;}
    #controls{background:var(--primary);padding:10px;text-align:center;}
    #controls button{margin:0 5px;padding:8px 12px;background:var(--accent);color:#fff;border:none;border-radius:4px;cursor:pointer;}
    #controls button:hover{background:#295427;}
    #add-form-container{display:none;background:#fff;padding:10px;border-bottom:1px solid #ccc;}
    #add-form input{margin:5px;padding:5px;width:100px;border:1px solid #ccc;border-radius:4px;}
    #map{height:50vh;}
    #history{padding:10px;background:#fff;border-top:1px solid #ccc;}
    #history h3{margin-top:0;color:var(--primary);}
    .cluster-carbon{font-weight:bold;color:#024a18;}
    .cluster-label{display:inline-block;background:#024a18;color:#fff;padding:2px 8px;border-radius:8px;font-size:13px;margin-right:6px;}
    .plot-btns{margin:8px 0;}
    .plot-btns button{margin:2px 4px 2px 0;padding:4px 8px;font-size:13px;}
  </style>
</head>
<body>
  <header>
    <a href="https://enableearth.eco" target="_blank"><img src="logo.png" alt="logo"></a>
  </header>

  <div id="controls"></div>
  <div id="add-form-container">
    <form id="add-form">
      <input id="input-id" type="text" placeholder="Plot ID" required>
      <input id="input-lat" type="number" step="any" placeholder="Latitude" required>
      <input id="input-lng" type="number" step="any" placeholder="Longitude" required>
      <input id="input-carbon" type="number" step="any" placeholder="Carbon" required>
      <button type="button" id="btn-save">Save</button>
      <button type="button" id="btn-cancel">Cancel</button>
    </form>
  </div>
  <div id="map"></div>
  <div id="history"><p>Select a plot to view history.</p></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script>
    let map, geoLayer, data, routingCtl, clusters = [];
    let markerClusterGroup, selectedPoints = [];

    function initMap() {
      map = L.map('map').setView([19.2,99.56], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:'&copy; OpenStreetMap contributors'
      }).addTo(map);
      L.Control.geocoder({defaultMarkGeocode:false})
        .on('markgeocode', e => map.fitBounds(e.geocode.bbox)).addTo(map);

      fetch('public/call.geojson')
        .then(r => r.json())
        .then(json => {
          data = { type:'FeatureCollection',
            features: json.features.map(f=>({...f,properties:{hasHistory:true,...f.properties}})) };
          clusters = getClusters(data.features);
          drawClusterLayer();
          buildControls();
          setupForm();
          showClusterInfo();
        });
    }

    // --- Cluster by distance (DBSCAN-like) ---
    function getClusters(features, eps=5) {
      // ไม่เอา Biochar Plant
      const plots = features.filter(f => f.properties.plot_id !== 'Biochar Plant');
      let clusters = [], visited=new Set();
      for (let i=0;i<plots.length;i++) {
        if (visited.has(i)) continue;
        let cluster=[plots[i]], stack=[i];
        visited.add(i);
        while(stack.length) {
          let idx=stack.pop();
          for (let j=0;j<plots.length;j++) {
            if (visited.has(j)) continue;
            let dist = turf.distance(
              turf.point(plots[idx].geometry.coordinates),
              turf.point(plots[j].geometry.coordinates),
              {units:'kilometers'}
            );
            if(dist<=eps) {
              visited.add(j); stack.push(j); cluster.push(plots[j]);
            }
          }
        }
        clusters.push(cluster);
      }
      return clusters;
    }

    function drawClusterLayer(filterFn) {
      if(markerClusterGroup) map.removeLayer(markerClusterGroup);
      if(geoLayer) map.removeLayer(geoLayer);

      markerClusterGroup = L.markerClusterGroup({
        showCoverageOnHover:false,
        spiderfyOnMaxZoom:true,
        maxClusterRadius:40
      });

      // Add only non-biochar points to cluster group
      const feats = (filterFn ? data.features.filter(filterFn) : data.features)
        .filter(f=>f.properties.plot_id !== "Biochar Plant");

      feats.forEach(f=>{
        const lat = f.geometry.coordinates[1];
        const lng = f.geometry.coordinates[0];
        const clusterIndex = getClusterIndex(f);
        const marker = L.marker([lat,lng], {
          title: f.properties.plot_id,
          icon: L.divIcon({
            className: 'custom-marker',
            html: `<div style="background:#336633;color:#fff;padding:3px 7px;border-radius:7px;font-weight:bold;">${f.properties.plot_id}</div>`,
            iconSize: [32,32], iconAnchor: [16,16]
          })
        }).bindPopup(
          `<span class="cluster-label">Cluster ${clusterIndex+1}</span><br>
          <strong>${f.properties.plot_id}</strong><br>
          Carbon: ${f.properties.carbon_credit||'-'} tCO₂`
        );
        marker.on('click',e=>{
          if(!e.originalEvent.ctrlKey) return;
          selectedPoints.push(e.latlng);
          if(selectedPoints.length===2){
            manualRoute(selectedPoints[0],selectedPoints[1]);
            selectedPoints=[];
          }
        });
        markerClusterGroup.addLayer(marker);
      });

      // Add Biochar Plant (not clustered)
      const biochar = data.features.find(f=>f.properties.plot_id==="Biochar Plant");
      if(biochar){
        geoLayer = L.geoJSON(biochar,{
          pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:10,color:'#1d3757',weight:2,fillColor:'#5e8af7',fillOpacity:.95}),
          onEachFeature:(f,lyr)=>lyr.bindPopup(`<strong>${f.properties.plot_id}</strong>`)
        }).addTo(map);
      }

      map.addLayer(markerClusterGroup);
      if(feats.length) map.fitBounds(markerClusterGroup.getBounds());

      markerClusterGroup.on('clusterclick', function (a) {
        // Zoom into cluster when clicked
        map.fitBounds(a.layer.getBounds());
      });

      // Customize cluster icon to show cluster count
      markerClusterGroup.options.iconCreateFunction = function(cluster){
        return L.divIcon({
          html: `<div style="background:#024a18;color:#fff;padding:3px 12px;border-radius:999px;font-weight:bold;font-size:16px;">${cluster.getChildCount()}</div>`,
          className: 'custom-cluster',
          iconSize: [38, 38]
        });
      };
    }

    function getClusterIndex(feature){
      for(let i=0; i<clusters.length; i++)
        if(clusters[i].some(f=>f.properties.plot_id===feature.properties.plot_id))
          return i;
      return -1;
    }

    function buildControls() {
      const c = document.getElementById('controls'); c.innerHTML = '';
      addBtn(c,'Show All',()=>{ drawClusterLayer(); showClusterInfo(); });
      addBtn(c,'History Plots',()=>{ drawClusterLayer(f=>f.properties.hasHistory); showHistoryPlots(); });
      addBtn(c,'Add Plot',()=>toggleForm(true));
      addBtn(c,'Routing',()=>{ routeFromBiocharCluster(); });
    }
    function addBtn(parent,text,fn) {
      const b=document.createElement('button');
      b.textContent=text; b.onclick=fn;
      parent.appendChild(b);
    }

    function setupForm() {
      document.getElementById('btn-save').onclick=()=>{
        const id  =document.getElementById('input-id').value.trim();
        const lat =parseFloat(document.getElementById('input-lat').value);
        const lng =parseFloat(document.getElementById('input-lng').value);
        const car =parseFloat(document.getElementById('input-carbon').value);
        if(!id||isNaN(lat)||isNaN(lng)||isNaN(car)) return alert('กรุณากรอกให้ครบ');
        data.features.push({ type:'Feature', properties:{plot_id:id, carbon_credit:car, hasHistory:true}, geometry:{type:'Point',coordinates:[lng,lat]} });
        clusters = getClusters(data.features);
        toggleForm(false); drawClusterLayer(); buildControls(); showClusterInfo();
      };
      document.getElementById('btn-cancel').onclick=()=>toggleForm(false);
    }
    function toggleForm(show) { document.getElementById('add-form-container').style.display = show?'block':'none'; }

    // --- Cluster info summary ---
    function showClusterInfo() {
      let html = `<h3>Cluster Info</h3>
        <ul>
          <li>จำนวน Cluster: <span class="cluster-carbon">${clusters.length}</span></li>`;
      clusters.forEach((cluster,i)=>{
        const carbonSum = cluster.reduce((s,f)=>(s+Number(f.properties.carbon_credit||0)),0);
       
